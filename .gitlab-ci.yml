image: debian:stretch
variables:
  DEBIAN_FRONTEND: noninteractive

test as root:
  stage: test
  script:
    - adduser --home /home/travis travis --quiet --disabled-login --gecos "" --uid 1000
    - rm -f /etc/dpkg/dpkg.cfg.d/excludes
    - apt-get update
    - apt-get install -qq build-essential expect sudo ninja-build
    - chmod -R o+rwX $PWD
    - ./prepare-release travis-ci
    - sudo -u travis mkdir -p build .ccache
    - ( cd build && sudo -u travis cmake -DCMAKE_BUILD_TYPE=Release -G Ninja .. )
    - sudo -u travis ninja -C build
    - CTEST_OUTPUT_ON_FAILURE=1 ninja -C build test
    - unbuffer ./test/integration/run-tests -q -j 4

test as user:
  stage: test
  script:
    - adduser --home /home/travis travis --quiet --disabled-login --gecos "" --uid 1000
    - rm -f /etc/dpkg/dpkg.cfg.d/excludes
    - apt-get update
    - apt-get install -qq build-essential expect sudo ninja-build
    - chmod 755 /root
    - chmod -R o+rwX $PWD
    - ./prepare-release travis-ci
    - sudo -u travis mkdir -p build .ccache
    - ( cd build && sudo -u travis cmake -DCMAKE_BUILD_TYPE=Release -G Ninja .. )
    - sudo -u travis ninja -C build
    - sudo -u travis CTEST_OUTPUT_ON_FAILURE=1 ninja -C build test
    - sudo -u travis unbuffer ./test/integration/run-tests -q -j 4
